{"version":3,"file":"manager.js","sources":["../../src/modifier/manager.ts"],"sourcesContent":["// @ts-expect-error\nimport { getValue } from '@glimmer/tracking/primitives/cache';\nimport { destroy } from '@ember/destroyable';\n// @ts-expect-error\nimport { invokeHelper } from '@ember/helper';\n// @ts-expect-error\nimport { capabilities } from '@ember/modifier';\n\nimport type { FunctionBasedModifierDefinition } from './index';\nimport type { ArgsFor, ElementFor } from '[core-types]';\n\ninterface State<S> {\n  instance: FunctionBasedModifierDefinition<S>;\n  helper: unknown;\n}\n\ninterface CreatedState<S> extends State<S> {\n  element: null;\n}\n\ninterface InstalledState<S> extends State<S> {\n  element: ElementFor<S>;\n}\n\n// Wraps the unsafe (b/c it mutates, rather than creating new state) code that\n// TS does not yet understand.\nfunction installElement<S>(state: CreatedState<S>, element: ElementFor<S>): InstalledState<S> {\n  // SAFETY: this cast represents how we are actually handling the state machine\n  // transition: from this point forward in the lifecycle of the modifier, it\n  // always behaves as `InstalledState<S>`. It is safe because, and *only*\n  // because, we immediately initialize `element`. (We cannot create a new state\n  // from the old one because the modifier manager API expects mutation of a\n  // single state bucket rather than updating it at hook calls.)\n  const installedState = state as State<S> as InstalledState<S>;\n\n  installedState.element = element;\n\n  return installedState;\n}\n\nfunction arrangeArgs(element: Element, args: any) {\n  const { positional, named } = args;\n\n  let flattenedArgs = [element, ...positional];\n\n  if (Object.keys(named).length > 0) {\n    flattenedArgs.push(named);\n  }\n\n  return flattenedArgs;\n}\n\nexport default class FunctionBasedModifierManager<S> {\n  capabilities = capabilities('3.22');\n\n  createModifier(instance: FunctionBasedModifierDefinition<S>): CreatedState<S> {\n    return { element: null, instance, helper: null };\n  }\n\n  installModifier(createdState: CreatedState<S>, element: ElementFor<S>, args: ArgsFor<S>): void {\n    const state = installElement(createdState, element);\n\n    this.updateModifier(state, args);\n  }\n\n  updateModifier(state: InstalledState<S>, args: ArgsFor<S>): void {\n    if (state.helper) {\n      destroy(state.helper);\n    }\n\n    state.helper = invokeHelper(this, state.instance, () => {\n      let foo = arrangeArgs(state.element, args);\n\n      return { positional: foo };\n    });\n\n    getValue(state.helper);\n  }\n\n  destroyModifier(state: InstalledState<S>): void {\n    if (state.helper) {\n      destroy(state.helper);\n    }\n  }\n}\n"],"names":["installElement","state","element","installedState","arrangeArgs","args","positional","named","flattenedArgs","Object","keys","length","push","FunctionBasedModifierManager","constructor","_defineProperty","capabilities","createModifier","instance","helper","installModifier","createdState","updateModifier","destroy","invokeHelper","foo","getValue","destroyModifier"],"mappings":";;;;;;AAwBA;AACA;AACA,SAASA,cAAcA,CAAIC,KAAsB,EAAEC,OAAsB,EAAqB;AAC5F;AACA;AACA;AACA;AACA;AACA;EACA,MAAMC,cAAc,GAAGF,KAAsC,CAAA;EAE7DE,cAAc,CAACD,OAAO,GAAGA,OAAO,CAAA;AAEhC,EAAA,OAAOC,cAAc,CAAA;AACvB,CAAA;AAEA,SAASC,WAAWA,CAACF,OAAgB,EAAEG,IAAS,EAAE;EAChD,MAAM;IAAEC,UAAU;AAAEC,IAAAA,KAAAA;AAAM,GAAC,GAAGF,IAAI,CAAA;AAElC,EAAA,IAAIG,aAAa,GAAG,CAACN,OAAO,EAAE,GAAGI,UAAU,CAAC,CAAA;EAE5C,IAAIG,MAAM,CAACC,IAAI,CAACH,KAAK,CAAC,CAACI,MAAM,GAAG,CAAC,EAAE;AACjCH,IAAAA,aAAa,CAACI,IAAI,CAACL,KAAK,CAAC,CAAA;AAC3B,GAAA;AAEA,EAAA,OAAOC,aAAa,CAAA;AACtB,CAAA;AAEe,MAAMK,4BAA4B,CAAI;EAAAC,WAAA,GAAA;AAAAC,IAAAA,eAAA,CACpCC,IAAAA,EAAAA,cAAAA,EAAAA,YAAY,CAAC,MAAM,CAAC,CAAA,CAAA;AAAA,GAAA;EAEnCC,cAAcA,CAACC,QAA4C,EAAmB;IAC5E,OAAO;AAAEhB,MAAAA,OAAO,EAAE,IAAI;MAAEgB,QAAQ;AAAEC,MAAAA,MAAM,EAAE,IAAA;KAAM,CAAA;AAClD,GAAA;AAEAC,EAAAA,eAAeA,CAACC,YAA6B,EAAEnB,OAAsB,EAAEG,IAAgB,EAAQ;AAC7F,IAAA,MAAMJ,KAAK,GAAGD,cAAc,CAACqB,YAAY,EAAEnB,OAAO,CAAC,CAAA;AAEnD,IAAA,IAAI,CAACoB,cAAc,CAACrB,KAAK,EAAEI,IAAI,CAAC,CAAA;AAClC,GAAA;AAEAiB,EAAAA,cAAcA,CAACrB,KAAwB,EAAEI,IAAgB,EAAQ;IAC/D,IAAIJ,KAAK,CAACkB,MAAM,EAAE;AAChBI,MAAAA,OAAO,CAACtB,KAAK,CAACkB,MAAM,CAAC,CAAA;AACvB,KAAA;IAEAlB,KAAK,CAACkB,MAAM,GAAGK,YAAY,CAAC,IAAI,EAAEvB,KAAK,CAACiB,QAAQ,EAAE,MAAM;MACtD,IAAIO,GAAG,GAAGrB,WAAW,CAACH,KAAK,CAACC,OAAO,EAAEG,IAAI,CAAC,CAAA;MAE1C,OAAO;AAAEC,QAAAA,UAAU,EAAEmB,GAAAA;OAAK,CAAA;AAC5B,KAAC,CAAC,CAAA;AAEFC,IAAAA,QAAQ,CAACzB,KAAK,CAACkB,MAAM,CAAC,CAAA;AACxB,GAAA;EAEAQ,eAAeA,CAAC1B,KAAwB,EAAQ;IAC9C,IAAIA,KAAK,CAACkB,MAAM,EAAE;AAChBI,MAAAA,OAAO,CAACtB,KAAK,CAACkB,MAAM,CAAC,CAAA;AACvB,KAAA;AACF,GAAA;AACF;;;;"}