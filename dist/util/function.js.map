{"version":3,"file":"function.js","sources":["../../src/util/function.ts"],"sourcesContent":["import { tracked } from '@glimmer/tracking';\nimport { deprecate } from '@ember/debug';\nimport { assert } from '@ember/debug';\nimport { associateDestroyableChild, destroy, isDestroyed, isDestroying } from '@ember/destroyable';\n\nimport { TrackedAsyncData } from 'ember-async-data';\n\nimport { resource } from '../core/function-based';\n\ndeprecate(\n  `importing from 'ember-resources/util/function' is deprecated and will be removed in ember-resources@v7. ` +\n    `The exact same code and support is available at https://github.com/universal-ember/reactiveweb. ` +\n    `\\`pnpm add reactiveweb\\` and then \\` import { trackedFunction } from 'reactiveweb/function';\\`. ` +\n    `See also: https://github.com/NullVoxPopuli/ember-resources/issues/1061`,\n  false,\n  {\n    id: `ember-resources.util.function`,\n    until: `7.0.0`,\n    for: `ember-resources`,\n    url: `https://reactive.nullvoxpopuli.com/functions/function.trackedFunction.html`,\n    since: {\n      available: '6.4.4',\n      enabled: '6.4.4',\n    },\n  },\n);\n\n/**\n * <div class=\"callout note\">\n *\n * This is not a core part of ember-resources, but is an example utility to demonstrate a concept when authoring your own resources. However, this utility is still under the broader library's SemVer policy.\n *\n * A consuming app will not pay for the bytes of this utility unless imported.\n *\n * </div>\n *\n * _An example utility that uses resource_\n *\n * Any tracked data accessed in a tracked function _before_ an `await`\n * will \"entangle\" with the function -- we can call these accessed tracked\n * properties, the \"tracked prelude\". If any properties within the tracked\n * payload  change, the function will re-run.\n *\n * ```js\n * import Component from '@glimmer/component';\n * import { tracked } from '@glimmer/tracking';\n * import { resourceFactory, resource, use } from 'ember-resources';\n * import { trackedFunction }  from 'ember-resources/util/function';\n * import { on } from '@ember/modifier';\n *\n * const Request = resourceFactory((idFn) => {\n *   return resource(({use}) => {\n *     let trackedRequest = use(trackedFunction(async () => {\n *       let id = idFn();\n *       let response = await fetch(`https://swapi.dev/api/people/${id}`);\n *       let data = await response.json();\n *\n *       return data; // { name: 'Luke Skywalker', ... }\n *     }));\n *\n *     return trackedRequest;\n *   });\n * });\n *\n * class Demo extends Component {\n *   @tracked id = 1;\n *\n *   updateId = (event) => this.id = event.target.value;\n *\n *   request = use(this, Request(() => this.id));\n *\n *   // Renders \"Luke Skywalker\"\n *   <template>\n *     {{this.request.current.value.name}}\n *\n *     <input value={{this.id}} {{on 'input' this.updateId}}>\n *   </template>\n * }\n * ```\n */\nexport function trackedFunction<Return>(fn: () => Return): State<Return>;\n\n/**\n * <div class=\"callout note\">\n *\n * This is not a core part of ember-resources, but is an example utility to demonstrate a concept when authoring your own resources. However, this utility is still under the broader library's SemVer policy.\n *\n * A consuming app will not pay for the bytes of this utility unless imported.\n *\n * </div>\n *\n * _An example utility that uses resource_\n *\n * Any tracked data accessed in a tracked function _before_ an `await`\n * will \"entangle\" with the function -- we can call these accessed tracked\n * properties, the \"tracked prelude\". If any properties within the tracked\n * payload  change, the function will re-run.\n *\n * ```js\n * import Component from '@glimmer/component';\n * import { tracked } from '@glimmer/tracking';\n * import { trackedFunction }  from 'ember-resources/util/function';\n *\n * class Demo extends Component {\n *   @tracked id = 1;\n *\n *   request = trackedFunction(this, async () => {\n *     let response = await fetch(`https://swapi.dev/api/people/${this.id}`);\n *     let data = await response.json();\n *\n *     return data; // { name: 'Luke Skywalker', ... }\n *   });\n *\n *   updateId = (event) => this.id = event.target.value;\n *\n *   // Renders \"Luke Skywalker\"\n *   <template>\n *     {{this.request.value.name}}\n *\n *     <input value={{this.id}} {{on 'input' this.updateId}}>\n *   </template>\n * }\n * ```\n * _Note_, this example uses the proposed `<template>` syntax from the [First-Class Component Templates RFC][rfc-799]\n *\n * Also note that after an `await`, the `this` context should not be accessed as it could lead to\n * destruction/timing issues.\n *\n * [rfc-799]: https://github.com/emberjs/rfcs/pull/779\n *\n * @param {Object} context destroyable parent, e.g.: component instance aka \"this\"\n * @param {Function} fn the function to run with the return value available on .value\n */\nexport function trackedFunction<Return>(context: object, fn: () => Return): State<Return>;\n\nexport function trackedFunction<Return>(\n  ...args: Parameters<typeof directTrackedFunction<Return>> | Parameters<typeof classUsable<Return>>\n): State<Return> {\n  if (args.length === 1) {\n    return classUsable(...args);\n  }\n\n  if (args.length === 2) {\n    return directTrackedFunction(...args);\n  }\n\n  assert('Unknown arity: trackedFunction must be called with 1 or 2 arguments');\n}\n\nfunction classUsable<Return>(fn: () => Return) {\n  const state = new State(fn);\n\n  let destroyable = resource<State<Return>>(() => {\n    state.retry();\n\n    return state;\n  });\n\n  associateDestroyableChild(destroyable, state);\n\n  return destroyable;\n}\n\nfunction directTrackedFunction<Return>(context: object, fn: () => Return) {\n  const state = new State(fn);\n\n  let destroyable = resource<State<Return>>(context, () => {\n    state.retry();\n\n    return state;\n  });\n\n  associateDestroyableChild(destroyable, state);\n\n  return destroyable;\n}\n\n/**\n * State container that represents the asynchrony of a `trackedFunction`\n */\nexport class State<Value> {\n  @tracked data: TrackedAsyncData<Value> | null = null;\n  @tracked declare promise: Value;\n\n  #fn: () => Value;\n\n  constructor(fn: () => Value) {\n    this.#fn = fn;\n  }\n\n  get state(): TrackedAsyncData<Value>['state'] | 'UNSTARTED' {\n    return this.data?.state ?? 'UNSTARTED';\n  }\n\n  /**\n   * Initially true, and remains true\n   * until the underlying promise resolves or rejects.\n   */\n  get isPending() {\n    if (!this.data) return true;\n\n    return this.data.isPending ?? false;\n  }\n\n  /**\n   * Alias for `isResolved || isRejected`\n   */\n  get isFinished() {\n    return this.isResolved || this.isRejected;\n  }\n\n  /**\n   * Alias for `isFinished`\n   * which is in turn an alias for `isResolved || isRejected`\n   */\n  get isSettled() {\n    return this.isFinished;\n  }\n\n  /**\n   * Alias for `isPending`\n   */\n  get isLoading() {\n    return this.isPending;\n  }\n\n  /**\n   * When true, the function passed to `trackedFunction` has resolved\n   */\n  get isResolved() {\n    return this.data?.isResolved ?? false;\n  }\n\n  /**\n   * Alias for `isRejected`\n   */\n  get isError() {\n    return this.isRejected;\n  }\n\n  /**\n   * When true, the function passed to `trackedFunction` has errored\n   */\n  get isRejected() {\n    return this.data?.isRejected ?? false;\n  }\n\n  /**\n   * this.data may not exist yet.\n   *\n   * Additionally, prior iterations of TrackedAsyncData did\n   * not allow the accessing of data before\n   * .state === 'RESOLVED'  (isResolved).\n   *\n   * From a correctness standpoint, this is perfectly reasonable,\n   * as it forces folks to handle the states involved with async functions.\n   *\n   * The original version of `trackedFunction` did not use TrackedAsyncData,\n   * and did not have these strictnesses upon property access, leaving folks\n   * to be as correct or as fast/prototype-y as they wished.\n   *\n   * For now, `trackedFunction` will retain that flexibility.\n   */\n  get value(): Awaited<Value> | null {\n    if (this.data?.isResolved) {\n      // This is sort of a lie, but it ends up working out due to\n      // how promises chain automatically when awaited\n      return this.data.value as Awaited<Value>;\n    }\n\n    return null;\n  }\n\n  /**\n   * When the function passed to `trackedFunction` throws an error,\n   * that error will be the value returned by this property\n   */\n  get error() {\n    return this.data?.error ?? null;\n  }\n\n  /**\n   * Will re-invoke the function passed to `trackedFunction`\n   * this will also re-set some properties on the `State` instance.\n   * This is the same `State` instance as before, as the `State` instance\n   * is tied to the `fn` passed to `trackedFunction`\n   *\n   * `error` or `resolvedValue` will remain as they were previously\n   * until this promise resolves, and then they'll be updated to the new values.\n   */\n  retry = async () => {\n    if (isDestroyed(this) || isDestroying(this)) return;\n\n    // We've previously had data, but we're about to run-again.\n    // we need to do this again so `isLoading` goes back to `true` when re-running.\n    // NOTE: we want to do this _even_ if this.data is already null.\n    //       it's all in the same tracking frame and the important thing is taht\n    //       we can't *read* data here.\n    this.data = null;\n\n    // We need to invoke this before going async so that tracked properties are consumed (entangled with) synchronously\n    this.promise = this.#fn();\n\n    // TrackedAsyncData interacts with tracked data during instantiation.\n    // We don't want this internal state to entangle with `trackedFunction`\n    // so that *only* the tracked data in `fn` can be entangled.\n    await Promise.resolve();\n\n    if (this.data) {\n      let isUnsafe = isDestroyed(this.data) || isDestroying(this.data);\n\n      if (!isUnsafe) {\n        destroy(this.data);\n        this.data = null;\n      }\n    }\n\n    if (isDestroyed(this) || isDestroying(this)) return;\n\n    // TrackedAsyncData manages the destroyable child association for us\n    this.data = new TrackedAsyncData(this.promise);\n\n    return this.promise;\n  };\n}\n"],"names":["deprecate","id","until","for","url","since","available","enabled","trackedFunction","args","length","classUsable","directTrackedFunction","assert","fn","state","State","destroyable","resource","retry","associateDestroyableChild","context","_class","_fn","WeakMap","constructor","_initializerDefineProperty","_descriptor","_descriptor2","_classPrivateFieldInitSpec","writable","value","_defineProperty","isDestroyed","isDestroying","data","promise","_classPrivateFieldGet","call","Promise","resolve","isUnsafe","destroy","TrackedAsyncData","_classPrivateFieldSet","isPending","isFinished","isResolved","isRejected","isSettled","isLoading","isError","error","_applyDecoratedDescriptor","prototype","tracked","configurable","enumerable","initializer"],"mappings":";;;;;;;;;;;;;AASAA,SAAS,CACN,CAAyG,wGAAA,CAAA,GACvG,CAAiG,gGAAA,CAAA,GACjG,kGAAiG,GACjG,CAAA,sEAAA,CAAuE,EAC1E,KAAK,EACL;AACEC,EAAAA,EAAE,EAAG,CAA8B,6BAAA,CAAA;AACnCC,EAAAA,KAAK,EAAG,CAAM,KAAA,CAAA;AACdC,EAAAA,GAAG,EAAG,CAAgB,eAAA,CAAA;AACtBC,EAAAA,GAAG,EAAG,CAA2E,0EAAA,CAAA;AACjFC,EAAAA,KAAK,EAAE;AACLC,IAAAA,SAAS,EAAE,OAAO;AAClBC,IAAAA,OAAO,EAAE,OAAA;AACX,GAAA;AACF,CACF,CAAC,CAAA;;AAED;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAGA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAGO,SAASC,eAAeA,CAC7B,GAAGC,IAA+F,EACnF;AACf,EAAA,IAAIA,IAAI,CAACC,MAAM,KAAK,CAAC,EAAE;AACrB,IAAA,OAAOC,WAAW,CAAC,GAAGF,IAAI,CAAC,CAAA;AAC7B,GAAA;AAEA,EAAA,IAAIA,IAAI,CAACC,MAAM,KAAK,CAAC,EAAE;AACrB,IAAA,OAAOE,qBAAqB,CAAC,GAAGH,IAAI,CAAC,CAAA;AACvC,GAAA;EAEAI,MAAM,CAAC,qEAAqE,CAAC,CAAA;AAC/E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"}