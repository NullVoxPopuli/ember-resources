{"version":3,"file":"manager.js","sources":["../../../src/core/function-based/manager.ts"],"sourcesContent":["// @ts-ignore\nimport { createCache, getValue } from '@glimmer/tracking/primitives/cache';\nimport { assert } from '@ember/debug';\nimport { associateDestroyableChild, destroy, registerDestructor } from '@ember/destroyable';\n// @ts-ignore\nimport { invokeHelper } from '@ember/helper';\n// @ts-ignore\nimport { capabilities as helperCapabilities } from '@ember/helper';\nimport { dependencySatisfies, importSync, macroCondition } from '@embroider/macros';\n\nimport { ReadonlyCell } from '../cell';\nimport { CURRENT, INTERNAL } from './types';\n\nimport type {\n  Cache,\n  Destructor,\n  InternalFunctionResourceConfig,\n  Reactive,\n  ResourceFunction,\n} from './types';\nimport type { ResourceAPI } from './types';\nimport type Owner from '@ember/owner';\n\nlet getOwner: (context: unknown) => Owner | undefined;\nlet setOwner: (context: unknown, owner: Owner) => void;\n\nif (macroCondition(dependencySatisfies('ember-source', '>=4.12.0'))) {\n  // In no version of ember where `@ember/owner` tried to be imported did it exist\n  // if (macroCondition(false)) {\n  // Using 'any' here because importSync can't lookup types correctly\n  getOwner = (importSync('@ember/owner') as any).getOwner;\n  setOwner = (importSync('@ember/owner') as any).setOwner;\n} else {\n  // Using 'any' here because importSync can't lookup types correctly\n  getOwner = (importSync('@ember/application') as any).getOwner;\n  setOwner = (importSync('@ember/application') as any).setOwner;\n}\n\n/**\n * Note, a function-resource receives on object, hooks.\n *    We have to build that manually in this helper manager\n */\nclass FunctionResourceManager {\n  capabilities = helperCapabilities('3.23', {\n    hasValue: true,\n    hasDestroyable: true,\n  });\n\n  constructor(protected owner: Owner) {}\n\n  /**\n   * Resources do not take args.\n   * However, they can access tracked data\n   */\n  createHelper(config: InternalFunctionResourceConfig) {\n    let { definition: fn } = config;\n    /**\n     * We have to copy the `fn` in case there are multiple\n     * usages or invocations of the function.\n     *\n     * This copy is what we'll ultimately work with and eventually\n     * destroy.\n     */\n    let thisFn = fn.bind(null);\n    let previousFn: object;\n    let usableCache = new WeakMap<object, unknown>();\n    let owner = this.owner;\n\n    let cache = createCache(() => {\n      if (previousFn) {\n        destroy(previousFn);\n      }\n\n      let currentFn = thisFn.bind(null);\n\n      associateDestroyableChild(thisFn, currentFn);\n      previousFn = currentFn;\n\n      const use: ResourceAPI['use'] = (usable) => {\n        assert(\n          `Expected the resource's \\`use(...)\\` utility to have been passed an object, but a \\`${typeof usable}\\` was passed.`,\n          typeof usable === 'object',\n        );\n        assert(\n          `Expected the resource's \\`use(...)\\` utility to have been passed a truthy value, instead was passed: ${usable}.`,\n          usable,\n        );\n        assert(\n          `Expected the resource's \\`use(...)\\` utility to have been passed another resource, but something else was passed.`,\n          INTERNAL in usable,\n        );\n\n        let previousCache = usableCache.get(usable);\n\n        if (previousCache) {\n          destroy(previousCache);\n        }\n\n        let nestedCache = invokeHelper(cache, usable);\n\n        associateDestroyableChild(currentFn, nestedCache as object);\n\n        usableCache.set(usable, nestedCache);\n\n        return new ReadonlyCell(() => {\n          let cache = usableCache.get(usable);\n\n          return getValue(cache);\n        });\n      };\n\n      let maybeValue = currentFn({\n        on: {\n          cleanup: (destroyer: Destructor) => {\n            registerDestructor(currentFn, destroyer);\n          },\n        },\n        use,\n        owner: this.owner,\n      });\n\n      return maybeValue;\n    });\n\n    setOwner(cache, owner);\n\n    return { fn: thisFn, cache };\n  }\n\n  getValue({ cache }: { fn: ResourceFunction; cache: Cache }) {\n    let maybeValue = getValue(cache);\n\n    if (typeof maybeValue === 'function') {\n      return maybeValue();\n    }\n\n    if (isReactive(maybeValue)) {\n      return maybeValue[CURRENT];\n    }\n\n    return maybeValue;\n  }\n\n  getDestroyable({ fn }: { fn: ResourceFunction }) {\n    return fn;\n  }\n}\n\nfunction isReactive<Value>(maybe: unknown): maybe is Reactive<Value> {\n  return typeof maybe === 'object' && maybe !== null && CURRENT in maybe;\n}\n\nexport const ResourceManagerFactory = (owner: Owner) => new FunctionResourceManager(owner);\n"],"names":["setOwner","macroCondition","dependencySatisfies","getOwner","importSync","FunctionResourceManager","constructor","owner","_defineProperty","helperCapabilities","hasValue","hasDestroyable","createHelper","config","definition","fn","thisFn","bind","previousFn","usableCache","WeakMap","cache","createCache","destroy","currentFn","associateDestroyableChild","use","usable","assert","INTERNAL","previousCache","get","nestedCache","invokeHelper","set","ReadonlyCell","getValue","maybeValue","on","cleanup","destroyer","registerDestructor","isReactive","CURRENT","getDestroyable","maybe","ResourceManagerFactory"],"mappings":"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"}