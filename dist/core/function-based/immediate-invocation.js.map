{"version":3,"file":"immediate-invocation.js","sources":["../../../src/core/function-based/immediate-invocation.ts"],"sourcesContent":["// @ts-ignore\nimport { createCache, getValue } from '@glimmer/tracking/primitives/cache';\nimport { associateDestroyableChild } from '@ember/destroyable';\n// @ts-ignore\nimport { capabilities as helperCapabilities, invokeHelper, setHelperManager } from '@ember/helper';\nimport { dependencySatisfies, importSync, macroCondition } from '@embroider/macros';\n\nimport type { resource } from './resource';\nimport type { Cache } from './types';\nimport type Owner from '@ember/owner';\n\ntype SpreadFor<T> = T extends Array<any> ? T : [T];\ntype ResourceFactory<Value = any, Args = any> = (...args: SpreadFor<Args>) => Value;\n\ninterface State {\n  cache: Cache;\n  fn: any;\n  args: any;\n  _?: any;\n}\n\nlet setOwner: (context: unknown, owner: Owner) => void;\n\nif (macroCondition(dependencySatisfies('ember-source', '>=4.12.0'))) {\n  // In no version of ember where `@ember/owner` tried to be imported did it exist\n  // if (macroCondition(false)) {\n  // Using 'any' here because importSync can't lookup types correctly\n  setOwner = (importSync('@ember/owner') as any).setOwner;\n} else {\n  // Using 'any' here because importSync can't lookup types correctly\n  setOwner = (importSync('@ember/application') as any).setOwner;\n}\n\nclass ResourceInvokerManager {\n  capabilities = helperCapabilities('3.23', {\n    hasValue: true,\n    hasDestroyable: true,\n  });\n\n  constructor(protected owner: Owner) {}\n\n  createHelper(fn: ResourceFactory, args: any): State {\n    /**\n     * This cache is for args passed to the ResourceInvoker/Factory\n     *\n     * We want to cache the helper result, and only re-inoke when the args\n     * change.\n     */\n    let cache = createCache(() => {\n      let resource = fn(...args.positional) as object;\n\n      setOwner(resource, this.owner);\n\n      return invokeHelper(cache, resource);\n    });\n\n    setOwner(cache, this.owner);\n\n    return { fn, args, cache, _: getValue(cache) };\n  }\n\n  /**\n   * getValue is re-called when args change\n   */\n  getValue({ cache }: State) {\n    let resource = getValue(cache);\n\n    associateDestroyableChild(cache, resource);\n\n    return getValue(resource);\n  }\n\n  getDestroyable({ cache }: State) {\n    return cache;\n  }\n}\n\n/**\n * Allows wrapper functions to provide a [[resource]] for use in templates.\n *\n * Only library authors may care about this, but helper function is needed to \"register\"\n * the wrapper function with a helper manager that specifically handles invoking both the\n * resource wrapper function as well as the underlying resource.\n *\n * _App-devs / consumers may not ever need to know this utility function exists_\n *\n *  Example using strict mode + `<template>` syntax and a template-only component:\n *  ```js\n *  import { resource, resourceFactory } from 'ember-resources';\n *\n *  const RemoteData = resourceFactory((url) => {\n *    return resource(({ on }) => {\n *      let state = new TrackedObject({});\n *      let controller = new AbortController();\n *\n *      on.cleanup(() => controller.abort());\n *\n *      fetch(url, { signal: controller.signal })\n *        .then(response => response.json())\n *        .then(data => {\n *          state.value = data;\n *        })\n *        .catch(error => {\n *          state.error = error;\n *        });\n *\n *      return state;\n *    })\n * });\n *\n *  <template>\n *    {{#let (RemoteData \"http://....\") as |state|}}\n *      {{#if state.value}}\n *        ...\n *      {{else if state.error}}\n *        {{state.error}}\n *      {{/if}}\n *    {{/let}}\n *  </template>\n *  ```\n *\n *  Alternatively, `resourceFactory` can wrap the wrapper function.\n *\n *  ```js\n *  const RemoteData = resourceFactory((url) => {\n *    return resource(({ on }) => {\n *      ...\n *    });\n *  })\n *  ```\n */\nexport function resourceFactory<Value = unknown, Args extends any[] = any[]>(\n  wrapperFn: (...args: Args) => ReturnType<typeof resource<Value>>,\n  /**\n   * This is a bonkers return type.\n   * Here are the scenarios:\n   *   const A = resourceFactory((...args) => {\n   *     return resource(({ on }) => {\n   *       ...\n   *     })\n   *   })\n   *\n   * Invocation styles need to be type-correct:\n   *   @use a = A(() => [b, c, d])\n   *   => single argument which is a function where the return type is the args\n   *\n   *   {{#let (A b c d) as |a|}}\n   *      {{a}}\n   *   {{/let}}\n   *   => args are passed directly as positional arguments\n   */\n) {\n  setHelperManager(ResourceInvokerFactory, wrapperFn);\n\n  return wrapperFn as ResourceBlueprint<Value, Args>;\n}\n\ntype ResourceBlueprint<Value, Args> =\n  /**\n   * Type for template invocation\n   *  {{#let (A b c d) as |a|}}\n   *     {{a}}\n   *  {{/let}}\n   *\n   * This could also be used in JS w/ invocation with @use\n   *   @use a = A(() => b)\n   *\n   * NOTE: it is up to the function passed to resourceFactory to handle some of the parameter ambiguity\n   */\n  | ((...args: SpreadFor<Args>) => ReturnType<typeof resource<Value>>)\n  /**\n   * Not passing args is allowed, too\n   *   @use a = A()\n   *\n   *   {{A}}\n   */\n  | (() => ReturnType<typeof resource<Value>>);\n// semicolon\n\n// Provide a singleton manager.\nconst ResourceInvokerFactory = (owner: Owner) => new ResourceInvokerManager(owner);\n"],"names":["setOwner","macroCondition","dependencySatisfies","importSync","ResourceInvokerManager","constructor","owner","_defineProperty","helperCapabilities","hasValue","hasDestroyable","createHelper","fn","args","cache","createCache","resource","positional","invokeHelper","_","getValue","associateDestroyableChild","getDestroyable","resourceFactory","wrapperFn","setHelperManager","ResourceInvokerFactory"],"mappings":";;;;;;AAqBA,IAAIA,QAAkD,CAAA;AAEtD,IAAIC,cAAc,CAACC,mBAAmB,CAAC,cAAc,EAAE,UAAU,CAAC,CAAC,EAAE;AACnE;AACA;AACA;AACAF,EAAAA,QAAQ,GAAIG,UAAU,CAAC,cAAc,CAAC,CAASH,QAAQ,CAAA;AACzD,CAAC,MAAM;AACL;AACAA,EAAAA,QAAQ,GAAIG,UAAU,CAAC,oBAAoB,CAAC,CAASH,QAAQ,CAAA;AAC/D,CAAA;AAEA,MAAMI,sBAAsB,CAAC;EAM3BC,WAAWA,CAAWC,KAAY,EAAE;AAAAC,IAAAA,eAAA,CALrBC,IAAAA,EAAAA,cAAAA,EAAAA,YAAkB,CAAC,MAAM,EAAE;AACxCC,MAAAA,QAAQ,EAAE,IAAI;AACdC,MAAAA,cAAc,EAAE,IAAA;AAClB,KAAC,CAAC,CAAA,CAAA;IAAA,IAEoBJ,CAAAA,KAAY,GAAZA,KAAY,CAAA;AAAG,GAAA;AAErCK,EAAAA,YAAYA,CAACC,EAAmB,EAAEC,IAAS,EAAS;AAClD;AACJ;AACA;AACA;AACA;AACA;AACI,IAAA,IAAIC,KAAK,GAAGC,WAAW,CAAC,MAAM;MAC5B,IAAIC,QAAQ,GAAGJ,EAAE,CAAC,GAAGC,IAAI,CAACI,UAAU,CAAW,CAAA;AAE/CjB,MAAAA,QAAQ,CAACgB,QAAQ,EAAE,IAAI,CAACV,KAAK,CAAC,CAAA;AAE9B,MAAA,OAAOY,YAAY,CAACJ,KAAK,EAAEE,QAAQ,CAAC,CAAA;AACtC,KAAC,CAAC,CAAA;AAEFhB,IAAAA,QAAQ,CAACc,KAAK,EAAE,IAAI,CAACR,KAAK,CAAC,CAAA;IAE3B,OAAO;MAAEM,EAAE;MAAEC,IAAI;MAAEC,KAAK;MAAEK,CAAC,EAAEC,QAAQ,CAACN,KAAK,CAAA;KAAG,CAAA;AAChD,GAAA;;AAEA;AACF;AACA;AACEM,EAAAA,QAAQA,CAAC;AAAEN,IAAAA,KAAAA;AAAa,GAAC,EAAE;AACzB,IAAA,IAAIE,QAAQ,GAAGI,QAAQ,CAACN,KAAK,CAAC,CAAA;AAE9BO,IAAAA,yBAAyB,CAACP,KAAK,EAAEE,QAAQ,CAAC,CAAA;IAE1C,OAAOI,QAAQ,CAACJ,QAAQ,CAAC,CAAA;AAC3B,GAAA;AAEAM,EAAAA,cAAcA,CAAC;AAAER,IAAAA,KAAAA;AAAa,GAAC,EAAE;AAC/B,IAAA,OAAOA,KAAK,CAAA;AACd,GAAA;AACF,CAAA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACO,SAASS,eAAeA,CAC7BC,SAAAA;AACA;AACF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,KACE;AACAC,EAAAA,gBAAgB,CAACC,sBAAsB,EAAEF,SAAS,CAAC,CAAA;AAEnD,EAAA,OAAOA,SAAS,CAAA;AAClB,CAAA;AAsBA;AAEA;AACA,MAAME,sBAAsB,GAAIpB,KAAY,IAAK,IAAIF,sBAAsB,CAACE,KAAK,CAAC;;;;"}